{% extends "admin/base_site.html" %}
{% load i18n %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–∞–ø–µ—Ä–∞–º–∏{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">–ì–ª–∞–≤–Ω–∞—è</a>
    ‚Ä∫ –°–∫—Ä–∞–ø–µ—Ä—ã
</div>
{% endblock %}

{% block content %}
<style>
    .scraper-container {
        max-width: 1000px;
    }
    .store-card {
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .store-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
    }
    .store-name {
        font-size: 1.5em;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .store-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2em;
    }
    .store-icon.pyaterochka { background: #e30613; }
    .store-icon.magnit { background: #e31e24; }
    .store-stats {
        color: #666;
        font-size: 0.9em;
    }
    .btn-group {
        display: flex;
        gap: 10px;
    }
    .btn-scrape {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 500;
        transition: all 0.2s;
    }
    .btn-demo {
        background: #417690;
        color: white;
    }
    .btn-demo:hover {
        background: #2e5265;
    }
    .btn-full {
        background: #22c55e;
        color: white;
    }
    .btn-full:hover {
        background: #16a34a;
    }
    .btn-scrape:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    .status-message {
        margin-top: 15px;
        padding: 10px 15px;
        border-radius: 6px;
        display: none;
    }
    .status-message.info {
        background: #e3f2fd;
        color: #1565c0;
        border: 1px solid #90caf9;
    }
    .status-message.success {
        background: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #a5d6a7;
    }
    .status-message.error {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ef9a9a;
    }
    .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #fff;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .help-text {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
    }
    .help-text h3 {
        margin-top: 0;
    }
    .help-text ul {
        margin-bottom: 0;
    }
</style>

<div class="scraper-container">
    <h1>ü§ñ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–∞–ø–µ—Ä–∞–º–∏</h1>
    
    <div class="help-text">
        <h3>‚ÑπÔ∏è –°–ø—Ä–∞–≤–∫–∞</h3>
        <ul>
            <li><strong>–î–µ–º–æ —Ä–µ–∂–∏–º</strong> ‚Äî –ø–∞—Ä—Å–∏—Ç —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é (–±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)</li>
            <li><strong>–ü–æ–ª–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥</strong> ‚Äî –ø–∞—Ä—Å–∏—Ç –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–∑–∞–Ω–∏–º–∞–µ—Ç 30-60 –º–∏–Ω—É—Ç)</li>
            <li>–°–∫—Ä–∞–ø–µ—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –±—Ä–∞—É–∑–µ—Ä Chrome –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ</li>
        </ul>
    </div>
    
    {% for store in stores %}
    <div class="store-card" id="store-{{ store.id }}">
        <div class="store-header">
            <div class="store-name">
                <span class="store-icon {% if store.id == '5ka' %}pyaterochka{% else %}magnit{% endif %}">
                    {% if store.id == '5ka' %}5{% else %}–ú{% endif %}
                </span>
                {{ store.name }}
            </div>
            <div class="store-stats">
                üì¶ {{ store.products|default:0 }} —Ç–æ–≤–∞—Ä–æ–≤ –≤ –±–∞–∑–µ
            </div>
        </div>
        
        <div class="btn-group">
            <button class="btn-scrape btn-demo" onclick="runScraper('{{ store.id }}', 'demo')">
                üöÄ –î–µ–º–æ —Ä–µ–∂–∏–º
            </button>
            <button class="btn-scrape btn-full" onclick="runScraper('{{ store.id }}', 'full')">
                üì¶ –ü–æ–ª–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥
            </button>
        </div>
        
        <div class="status-message" id="status-{{ store.id }}"></div>
    </div>
    {% endfor %}
</div>

<script>
let isRunning = false;

function runScraper(store, mode) {
    if (isRunning) {
        alert('–°–∫—Ä–∞–ø–µ—Ä —É–∂–µ –∑–∞–ø—É—â–µ–Ω!');
        return;
    }
    
    const modeName = mode === 'full' ? '–ø–æ–ª–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥' : '–¥–µ–º–æ —Ä–µ–∂–∏–º';
    if (mode === 'full' && !confirm(`–ó–∞–ø—É—Å—Ç–∏—Ç—å ${modeName}? –≠—Ç–æ –∑–∞–π–º–µ—Ç 30-60 –º–∏–Ω—É—Ç.`)) {
        return;
    }
    
    isRunning = true;
    
    // Disable all buttons
    document.querySelectorAll('.btn-scrape').forEach(btn => btn.disabled = true);
    
    // Show status
    const statusEl = document.getElementById('status-' + store);
    statusEl.className = 'status-message info';
    statusEl.innerHTML = '<span class="spinner"></span> –°–∫—Ä–∞–ø–µ—Ä –∑–∞–ø—É—â–µ–Ω, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...';
    statusEl.style.display = 'block';
    
    // Send request
    fetch('{% url "admin:run_scraper" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `store=${store}&mode=${mode}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusEl.className = 'status-message success';
            statusEl.innerHTML = '‚úÖ ' + data.message;
            // Start polling for status
            pollStatus(store);
        } else {
            statusEl.className = 'status-message error';
            statusEl.innerHTML = '‚ùå ' + data.message;
            enableButtons();
        }
    })
    .catch(error => {
        statusEl.className = 'status-message error';
        statusEl.innerHTML = '‚ùå –û—à–∏–±–∫–∞: ' + error;
        enableButtons();
    });
}

function pollStatus(store) {
    const statusEl = document.getElementById('status-' + store);
    
    const check = () => {
        fetch('{% url "admin:scraper_status" %}')
        .then(response => response.json())
        .then(data => {
            if (data.running) {
                statusEl.innerHTML = '<span class="spinner"></span> –°–∫—Ä–∞–ø–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è ' + (data.store === '5ka' ? '–ü—è—Ç—ë—Ä–æ—á–∫–∞' : '–ú–∞–≥–Ω–∏—Ç') + '...';
                setTimeout(check, 3000);
            } else {
                if (data.result) {
                    if (data.result.success) {
                        statusEl.className = 'status-message success';
                        statusEl.innerHTML = '‚úÖ –°–∫—Ä–∞–ø–µ—Ä –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É!';
                    } else {
                        statusEl.className = 'status-message error';
                        statusEl.innerHTML = '‚ùå –û—à–∏–±–∫–∞: ' + (data.result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                    }
                }
                enableButtons();
                // Reload page to update product counts
                setTimeout(() => location.reload(), 2000);
            }
        });
    };
    
    setTimeout(check, 3000);
}

function enableButtons() {
    isRunning = false;
    document.querySelectorAll('.btn-scrape').forEach(btn => btn.disabled = false);
}
</script>
{% endblock %}

